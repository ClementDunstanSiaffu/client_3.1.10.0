"use strict";var __awaiter=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(o,a){function i(e){try{c(n.next(e))}catch(e){a(e)}}function u(e){try{c(n.throw(e))}catch(e){a(e)}}function c(e){var t;e.done?o(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(i,u)}c((n=n.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var r,n,o,a,i={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return a={next:u(0),throw:u(1),return:u(2)},"function"==typeof Symbol&&(a[Symbol.iterator]=function(){return this}),a;function u(a){return function(u){return function(a){if(r)throw new TypeError("Generator is already executing.");for(;i;)try{if(r=1,n&&(o=2&a[0]?n.return:a[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,a[1])).done)return o;switch(n=0,o&&(a=[2&a[0],o.value]),a[0]){case 0:case 1:o=a;break;case 4:return i.label++,{value:a[1],done:!1};case 5:i.label++,n=a[1],a=[0];continue;case 7:a=i.ops.pop(),i.trys.pop();continue;default:if(!((o=(o=i.trys).length>0&&o[o.length-1])||6!==a[0]&&2!==a[0])){i=0;continue}if(3===a[0]&&(!o||a[1]>o[0]&&a[1]<o[3])){i.label=a[1];break}if(6===a[0]&&i.label<o[1]){i.label=o[1],o=a;break}if(o&&i.label<o[2]){i.label=o[2],i.ops.push(a);break}o[2]&&i.ops.pop(),i.trys.pop();continue}a=t.call(e,i)}catch(e){a=[6,e],n=0}finally{r=o=0}if(5&a[0])throw a[1];return{value:a[0]?a[1]:void 0,done:!0}}([a,u])}}};Object.defineProperty(exports,"__esModule",{value:!0}),exports.ArcGISClient=void 0;var TokenProvider_1=require("./TokenProvider"),SettingsHelper_1=require("./SettingsHelper"),ArcGISClient=function(){function e(){}return e.executeSelf=function(){return new Promise((function(t,r){TokenProvider_1.TokenProvider.getToken().then((function(n){n===e._lastSelfToken?t(e._selfResult):e.executeRequest({taskPath:"/portals/self",data:{culture:"en-us"}}).then((function(r){e._lastSelfToken=n,e._selfResult=r,t(r)})).catch((function(t){e._lastSelfToken="",e._selfResult="",r(t)}))})).catch((function(e){return r(e)}))}))},e.getGeoenrichmentUrl=function(){return e.getHelperServiceUrl("geoenrichment")},e.getHelperServiceUrl=function(t){return new Promise((function(r,n){e.executeSelf().then((function(e){var o=e.helperServices;if(o){var a=o[t];if(a){var i=Array.isArray(a)?a[0].url:a.url;i?r(i):n(t+" helper service is not configured.")}else n(t+" helper service is not configured.")}else n("Helper services are not configured.")})).catch((function(e){return n(e)}))}))},e.getPortalResource=function(t){return e.executeRequest({taskPath:"/portals/self/resources/"+t})},e.getItemData=function(t){return e.executeRequest({taskPath:"/content/items/"+t+"/data"})},e.searchAllItems=function(e,t){var r=this;return new Promise((function(n,o){var a=[],i=r,u=function(e,t,r){i.searchItems(e,t,r).then((function(r){r.items.length&&(a=a.concat(r.items));var o=r.context;o.nextStart>0?u(e,t,o):n(a)}),(function(e){a&&a.length?n(a):o(e)}))};u(e,t,null)}))},e.searchItems=function(t,r,n){return new Promise((function(o,a){var i=r?JSON.parse(JSON.stringify(r)):{};if(n){i.q=r.q;var u=n.total,c=n.nextStart;u&&c&&(c>0&&u>=c?i.start=c:o({items:[],context:n})),n.sortField&&n.sortOrder&&(i.sortOrder=n.sortOrder,i.sortField=n.sortField)}else{var s=[];Object.getOwnPropertyNames(t).forEach((function(e){s.push(e+':"'+t[e]+'"')})),s.length&&(i.q=s.join(" AND "))}e.portalSearch(i).then((function(e){var t=e.results,r={query:e.query,total:e.total,nextStart:e.nextStart,sortOrder:null,sortField:null};i.sortOrder&&i.sortField&&(r.sortOrder=i.sortOrder,r.sortField=i.sortField),o({items:t,context:r})})).catch(a)}))},e.portalSearch=function(t){return e.executeRequest({taskPath:"/search",data:t})},e.getPortalUrl=function(){return __awaiter(this,void 0,void 0,(function(){return __generator(this,(function(e){switch(e.label){case 0:return[4,SettingsHelper_1.SettingsHelper.getPortalBaseUrl()];case 1:return[2,e.sent()+"/sharing/rest"]}}))}))},e.executeRequest=function(t){var r=this;return new Promise((function(n,o){TokenProvider_1.TokenProvider.getToken().then((function(a){return __awaiter(r,void 0,void 0,(function(){var r,i,u;return __generator(this,(function(c){switch(c.label){case 0:for(i in t.data||(t.data={}),t.data.f||(t.data.f="json"),t.data.token=a,t.data.langCode="en-us",r=new FormData,t.data)r.append(i,t.data[i]);return Object.prototype.hasOwnProperty.call(t,"url")?(u=t.url,[3,3]):[3,1];case 1:return[4,e.getPortalUrl()];case 2:u=c.sent(),c.label=3;case 3:return t.taskPath&&(u+=t.taskPath),fetch(u,{method:"POST",body:r}).then((function(e){if(!e.ok)throw new Error("Network response ended with error.");return"bin"===t.data.f?e.blob():e.json()})).then((function(e){e.error?o(e.error):n(e)})).catch((function(e){console.error("Error:",e),o(e)})),[2]}}))}))})).catch((function(e){return o(e)}))}))},e}();exports.ArcGISClient=ArcGISClient;