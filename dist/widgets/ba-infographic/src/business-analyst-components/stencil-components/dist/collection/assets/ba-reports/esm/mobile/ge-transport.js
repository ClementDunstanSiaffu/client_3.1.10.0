var __awaiter=this&&this.__awaiter||function(e,t,r,a){return new(r||(r=Promise))((function(i,o){function s(e){try{l(a.next(e))}catch(e){o(e)}}function n(e){try{l(a.throw(e))}catch(e){o(e)}}function l(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(s,n)}l((a=a.apply(e,t||[])).next())}))},__generator=this&&this.__generator||function(e,t){var r,a,i,o,s={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:n(0),throw:n(1),return:n(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function n(o){return function(n){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,a&&(i=2&o[0]?a.return:o[0]?a.throw||((i=a.return)&&i.call(a),0):a.next)&&!(i=i.call(a,o[1])).done)return i;switch(a=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return s.label++,{value:o[1],done:!1};case 5:s.label++,a=o[1],o=[0];continue;case 7:o=s.ops.pop(),s.trys.pop();continue;default:if(!((i=(i=s.trys).length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){s=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){s.label=o[1];break}if(6===o[0]&&s.label<i[1]){s.label=i[1],i=o;break}if(i&&s.label<i[2]){s.label=i[2],s.ops.push(o);break}i[2]&&s.ops.pop(),s.trys.pop();continue}o=t.call(e,s)}catch(e){o=[6,e],a=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,n])}}};import{GEClient}from"./GEClient";import{TokenProvider}from"./TokenProvider";import D from"../DebugLog";var TransportUtil=function(){function e(){this.fixForLint="",D.showDebugConsoleLogs=!1}return e.setToken=function(e,t){TokenProvider.setToken(e,t)},e.getBuffers=function(t,r,a,i,o,s){return __awaiter(this,void 0,void 0,(function(){var n,l,u,m,c,d,f,p;return __generator(this,(function(v){switch(v.label){case 0:if("drivetime"!=t&&"walktime"!=t)throw"TransportUtil - invalid args";if(!(e.hasText(r)&&e.hasText(a)&&e.hasText(i)&&null!=typeof o&&null!=typeof s))return[3,3];for(n=[],l=i.split(","),f=0;f<l.length;f++)n.push(parseFloat(l[f]));return[4,e.getParams(t,r,a,n,o,s)];case 1:return u=v.sent(),D.log(" GE Request PARAMS = ",u),[4,GEClient.enrich(u)];case 2:if(m=v.sent(),D.log("ge-transport enrich result",m),c=m.results[0].value.FeatureSet[0].spatialReference,d=e.parseRings(m),D.log("ge-transport rings",d),d)for(f=0;f<d.length;f++)d[f]&&((p=d[f]).transport="drivetime"==t?"drive":"walk",p.latitude=s,p.longitude=o,p.spatial=c,p.location={geometry:{x:o,y:s,spatialReference:{wkid:4326}},symbol:{type:"esriPMS",width:14,height:26.6,xoffset:0,yoffset:12.6,contentType:"image/png",imageData:"iVBORw0KGgoAAAANSUhEUgAAABMAAAAjCAYAAAB2KjFhAAACtUlEQVRIS+2WS0wTURSG/zvT0kpfkGJ4pGCViA1Em9CtCQVx5QIWhiVRo8GdSNypqHElkcgOlzVh5ap1X6nEiAkQXzGBxkSKtZC0jdTSB7SdMXdwRjudB+w5q5t7T775z3/OzR0CWbT4x90Glh0CMEx43g1C3FIKz6/zhKwDCJYrldBWZIaupSDiqsE/3mBjmGeMyXLF7GiBubEVhmN2sIY6KblS3kO58BvFX5soZrbA7eYCWY67vR2Z2aZJAoyqMTLMvLXN47a1eeRiUSrmUSrmhHSGNYA11oGtMyO3FcVOYnW9xHH9VKUAcw1MfHSc9HktzvYaEN34B6suymSxCwozsQ+ReHi6n7gG7/iNZvv88W6/Ikgdtl+Y2d6I5NfXqJQK/cQ1MPHQ1uZ5oFSeSFdWtn9Ky93b/olsYvURhUWcXef7TPamGmWXfM3oPeVAi8OIeDKLpWgSrxY3qvIY1gjCl5GOvn2jCLOaWUyN9sDX6aj5wNJaErdm3yNbKAlnurCp0W709ThVPQy+i+H+ixV92OlWC+bGe1VB4sHlx2GsxTPayqhPkyNdurB7gRWEFmPasBsXT+D6YIcu7MnLz5gLf9OG0e7Njp3ThV2bXsBSNKUNo518ftML6p1aUK+oZwfqJgVRIAXLg47E1acLgvkHgtGk1kYTJkfOCEMrxnI0hbuBZSTSeWlPd87kaprqeWwkUopVHxqmdTePYMqTdeRZ9d1svzARtLnODlmbO1XvoqpnhMBkaUAhHUM2/iVE6ONrZZjIoZ+6v6BiZhOZ7yufdjjOL7ybesAaZQog+qpX/R6oKayCqYCoKAmmpVCCaYBqYGpAAbabF8z+3yPxh0XsXJUycVPuYWm3IIyAFkhRmRowl/4hdU2uSFOZHFjv7PDm0xtC+9VAmspkwOAOxw1rgWj+H4uVH6hj08HSAAAAAElFTkSuQmCC"}});return[2,d];case 3:return[2,null]}}))}))},e.parseRings=function(e){var t=[];try{if(e&&e.results&&e.results.length>0){var r=e.results[0].value.FeatureSet[0];if(r.features&&r.features.length>0){for(var a=0;a<r.features.length;a++){var i=r.features[a],o=i.attributes.bufferRadii,s=i.attributes.bufferUnits,n=i.geometry.rings;t.push({value:o,units:s,rings:n})}return t}}}catch(e){console.log(e),D.log("Transport parse","GE result is invalid")}},e.hasText=function(e){return null!=typeof e&&e.trim().length>0},e.getParams=function(e,t,r,a,i,o){return __awaiter(this,void 0,void 0,(function(){var s,n,l,u,m,c,d;return __generator(this,(function(f){switch(f.label){case 0:return s="minutes"==r.toLowerCase(),n="drivetime"==e,[4,GEClient.getDefaultHierarchy(t)];case 1:return l=f.sent(),console.log("DEFAULT HIERARCHY",l),u={sourceCountry:t,hierarchy:l},m=JSON.stringify(u),n?(D.log("getBuffers","DRIVE SETTINGS"),c=[{bufferUnits:s?"Minutes":"miles"==r?"esriMiles":"esriKilometers",bufferRadii:a,areaType:"NetworkServiceArea",travel_mode:{attributeParameterValues:[{parameterName:"Restriction Usage",attributeName:"Avoid Unpaved Roads",value:"AVOID_HIGH"},{parameterName:"Restriction Usage",attributeName:"Avoid Private Roads",value:"AVOID_MEDIUM"},{parameterName:"Restriction Usage",attributeName:"Driving an Automobile",value:"PROHIBITED"},{parameterName:"Restriction Usage",attributeName:"Through Traffic Prohibited",value:"AVOID_HIGH"},{parameterName:"Vehicle Maximum Speed (km/h)",attributeName:"TravelTime",value:0},{parameterName:"Restriction Usage",attributeName:"Roads Under Construction Prohibited",value:"PROHIBITED"},{parameterName:"Restriction Usage",attributeName:"Avoid Gates",value:"AVOID_MEDIUM"},{parameterName:"Restriction Usage",attributeName:"Avoid Express Lanes",value:"PROHIBITED"},{parameterName:"Restriction Usage",attributeName:"Avoid Carpool Roads",value:"PROHIBITED"}],description:"Models the movement of cars and other similar small automobiles, such as pickup trucks, and finds solutions that optimize travel time. Travel obeys one-way roads, avoids illegal turns, and follows other rules that are specific to cars. When you specify a start time, dynamic travel speeds based on traffic are used where it is available.",impedanceAttributeName:s?"TravelTime":"Kilometers",simplificationToleranceUnits:"esriMeters",uturnAtJunctions:"esriNFSBAtDeadEndsAndIntersections",restrictionAttributeNames:["Avoid Unpaved Roads","Avoid Private Roads","Driving an Automobile","Through Traffic Prohibited","Roads Under Construction Prohibited","Avoid Gates","Avoid Express Lanes","Avoid Carpool Roads"],useHierarchy:!0,simplificationTolerance:10,timeAttributeName:"TravelTime",distanceAttributeName:"Kilometers",type:"AUTOMOBILE",id:"FEgifRtFndKNcJMJ",name:s?"Driving Time":"Driving Distance"},networkOptions:{travel_direction:"Away From Facility",polygon_overlap_type:"Disks"},returnGeometry:!0,geometry:{x:i,y:o,spatialReference:{wkid:4326,latestWkid:4326}}}]):(D.log("getBuffers","WALK SETTINGS"),c=[{bufferUnits:s?"Minutes":"miles"==r?"esriMiles":"esriKilometers",bufferRadii:a,areaType:"NetworkServiceArea",travel_mode:{attributeParameterValues:[{parameterName:"Restriction Usage",attributeName:"Avoid Private Roads",value:"AVOID_MEDIUM"},{parameterName:"Restriction Usage",attributeName:"Walking",value:"PROHIBITED"},{parameterName:"Restriction Usage",attributeName:"Preferred for Pedestrians",value:"PREFER_LOW"},{parameterName:"Walking Speed (km/h)",attributeName:"WalkTime",value:5},{parameterName:"Restriction Usage",attributeName:"Avoid Roads Unsuitable for Pedestrians",value:"AVOID_HIGH"}],description:"Follows paths and roads that allow pedestrian traffic and finds solutions that optimize travel time. The walking speed is set to 5 kilometers per hour.",impedanceAttributeName:s?"WalkTime":"Kilometers",simplificationToleranceUnits:"esriMeters",uturnAtJunctions:"esriNFSBAllowBacktrack",restrictionAttributeNames:["Avoid Private Roads","Avoid Roads Unsuitable for Pedestrians","Preferred for Pedestrians","Walking"],useHierarchy:!1,simplificationTolerance:s?2:38,timeAttributeName:"WalkTime",distanceAttributeName:"Kilometers",type:"WALK",id:"caFAgoThrvUpkFBW",name:s?"Walking Time":"Walking Distance"},networkOptions:{polygon_overlap_type:"Disks"},returnGeometry:!0,geometry:{x:i,y:o,spatialReference:{wkid:4326,latestWkid:4326}}}]),d=JSON.stringify(c),[2,{returnGeometry:"true",outSR:"4326",useData:m,studyareas:d,forStorage:!1}]}}))}))},e}();export default TransportUtil;